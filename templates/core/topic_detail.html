{% extends 'base.html' %}

{% block title %}{{ topic.title }} - Teacher Assistant{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
                <li class="breadcrumb-item">{{ topic.group.name }}</li>
                <li class="breadcrumb-item active">{{ topic.title }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>{{ topic.title }}</h1>
            {% if progress.completed %}
            <span class="badge bg-success fs-6">
                <i class="fas fa-check-circle me-1"></i>Completed ({{ progress.final_score }}/20)
            </span>
            {% endif %}
        </div>

        <p class="lead text-muted">{{ topic.description }}</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-paint-brush me-2"></i>Interactive Canvas
                </h5>
            </div>
            <div class="card-body p-0">
                <!-- Canvas Toolbar -->
                <div class="toolbar bg-light p-3 border-bottom">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="btn-group me-3" role="group">
                                <button type="button" class="btn btn-outline-primary active" id="drawBtn">
                                    <i class="fas fa-pencil-alt"></i> Draw
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="eraseBtn">
                                    <i class="fas fa-eraser"></i> Erase
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="textBtn">
                                    <i class="fas fa-font"></i> Text
                                </button>
                            </div>

                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary" id="clearBtn">
                                    <i class="fas fa-trash"></i> Clear
                                </button>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="d-flex align-items-center justify-content-end">
                                <label class="me-2">Color:</label>
                                <div class="color-palette me-3">
                                    <button class="color-btn active" data-color="#000000"
                                        style="background: #000000;"></button>
                                    <button class="color-btn" data-color="#ff0000"
                                        style="background: #ff0000;"></button>
                                    <button class="color-btn" data-color="#00ff00"
                                        style="background: #00ff00;"></button>
                                    <button class="color-btn" data-color="#0000ff"
                                        style="background: #0000ff;"></button>
                                    <button class="color-btn" data-color="#ffff00"
                                        style="background: #ffff00;"></button>
                                    <button class="color-btn" data-color="#ff00ff"
                                        style="background: #ff00ff;"></button>
                                    <button class="color-btn" data-color="#00ffff"
                                        style="background: #00ffff;"></button>
                                    <button class="color-btn" data-color="#ffa500"
                                        style="background: #ffa500;"></button>
                                </div>

                                <label class="me-2">Size:</label>
                                <input type="range" class="form-range" id="brushSize" min="1" max="20" value="3"
                                    style="width: 80px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Canvas Container -->
                <div class="canvas-container position-relative">
                    <canvas id="drawingCanvas" width="800" height="600" class="border-0"></canvas>
                    {% if background_image_url %}
                    <img id="backgroundImage" src="{{ background_image_url }}" style="display: none;">
                    {% endif %}
                </div>

                <!-- Submit Button -->
                <div class="p-3 bg-light border-top">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">
                                Time: <span id="timer">00:00</span>
                                {% if progress.total_attempts > 0 %}
                                | Attempt: {{ progress.total_attempts|add:1 }}
                                {% endif %}
                            </small>
                        </div>
                        <button type="button" class="btn btn-success" id="submitBtn" {% if progress.completed %}disabled{% endif %}>
                            <i class="fas fa-paper-plane me-1"></i>Submit Drawing
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Instructions -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>Instructions
                </h5>
            </div>
            <div class="card-body">
                <div id="instructionalText">
                    {{ instructional_text|linebreaks }}
                </div>
            </div>
        </div>

        <!-- Progress Info -->
        {% if progress.total_attempts > 0 %}
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Your Progress
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <h4 class="text-primary">{{ progress.total_attempts }}</h4>
                            <small class="text-muted">Attempts</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <h4 class="text-info">
                            {% if progress.total_time_spent %}
                            {{ progress.total_time_spent|floatformat:0 }}s
                            {% else %}
                            0s
                            {% endif %}
                        </h4>
                        <small class="text-muted">Total Time</small>
                    </div>
                </div>

                {% if latest_attempt %}
                <hr>
                <div class="mt-3">
                    <h6>Latest Attempt:</h6>
                    {% if latest_attempt.score %}
                    <div class="mb-2">
                        <span class="badge bg-primary">Score: {{ latest_attempt.score }}/20</span>
                    </div>
                    {% endif %}
                    {% if latest_attempt.feedback %}
                    <div class="alert alert-info small">
                        {{ latest_attempt.feedback }}
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Submission Modal -->
<div class="modal fade" id="submissionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Submission Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="submissionResult">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                    <p class="mt-2">Evaluating your drawing...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="continueBtn" style="display: none;">Continue</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .canvas-container {
        background: #f8f9fa;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 600px;
    }

    #drawingCanvas {
        background: white;
        cursor: crosshair;
        z-index: 2;
    }

    #backgroundImage {
        max-width: 800px;
        max-height: 600px;
        opacity: 0.7;
    }

    .color-palette {
        display: flex;
        gap: 5px;
    }

    .color-btn {
        width: 25px;
        height: 25px;
        border: 2px solid #ccc;
        border-radius: 50%;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .color-btn:hover {
        transform: scale(1.1);
    }

    .color-btn.active {
        border-color: #007bff;
        border-width: 3px;
    }

    .toolbar {
        background: #f8f9fa !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Canvas Drawing Implementation
    class DrawingCanvas {
        constructor(canvasId) {
            this.canvas = document.getElementById(canvasId);
            this.ctx = this.canvas.getContext('2d');
            this.isDrawing = false;
            this.currentTool = 'draw';
            this.currentColor = '#000000';
            this.currentSize = 3;
            this.startTime = Date.now();
            this.backgroundImage = null;

            this.loadBackgroundImage();
            this.setupEventListeners();
            this.setupToolbar();
            this.startTimer();
        }

        loadBackgroundImage() {
            const bgImgElement = document.getElementById('backgroundImage');
            if (bgImgElement) {
                this.backgroundImage = new Image();
                this.backgroundImage.onload = () => {
                    this.drawBackground();
                };
                this.backgroundImage.src = bgImgElement.src;
            }
        }

        drawBackground() {
            if (this.backgroundImage) {
                this.ctx.save();
                this.ctx.globalAlpha = 0.7;
                this.ctx.drawImage(this.backgroundImage, 0, 0, this.canvas.width, this.canvas.height);
                this.ctx.restore();
            }
        }

        setupEventListeners() {
            this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
            this.canvas.addEventListener('mousemove', (e) => this.draw(e));
            this.canvas.addEventListener('mouseup', () => this.stopDrawing());
            this.canvas.addEventListener('mouseout', () => this.stopDrawing());

            // Touch events for mobile
            this.canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                this.canvas.dispatchEvent(mouseEvent);
            });

            this.canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                this.canvas.dispatchEvent(mouseEvent);
            });

            this.canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                const mouseEvent = new MouseEvent('mouseup', {});
                this.canvas.dispatchEvent(mouseEvent);
            });
        }

        setupToolbar() {
            // Tool buttons
            document.getElementById('drawBtn').addEventListener('click', () => this.setTool('draw'));
            document.getElementById('eraseBtn').addEventListener('click', () => this.setTool('erase'));
            document.getElementById('textBtn').addEventListener('click', () => this.setTool('text'));
            document.getElementById('clearBtn').addEventListener('click', () => this.clearCanvas());

            // Color palette
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.addEventListener('click', (e) => this.setColor(e.target.dataset.color));
            });

            // Brush size
            document.getElementById('brushSize').addEventListener('input', (e) => {
                this.currentSize = e.target.value;
            });

            // Submit button
            document.getElementById('submitBtn').addEventListener('click', () => this.submitDrawing());
        }

        setTool(tool) {
            this.currentTool = tool;

            // Update button states
            document.querySelectorAll('.toolbar .btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tool + 'Btn').classList.add('active');

            // Update cursor
            if (tool === 'erase') {
                this.canvas.style.cursor = 'grab';
            } else if (tool === 'text') {
                this.canvas.style.cursor = 'text';
            } else {
                this.canvas.style.cursor = 'crosshair';
            }
        }

        setColor(color) {
            this.currentColor = color;

            // Update color button states
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-color="${color}"]`).classList.add('active');
        }

        getMousePos(e) {
            const rect = this.canvas.getBoundingClientRect();
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        startDrawing(e) {
            this.isDrawing = true;
            const pos = this.getMousePos(e);

            if (this.currentTool === 'text') {
                this.addText(pos);
            } else {
                this.ctx.beginPath();
                this.ctx.moveTo(pos.x, pos.y);
            }
        }

        draw(e) {
            if (!this.isDrawing) return;

            const pos = this.getMousePos(e);

            this.ctx.lineWidth = this.currentSize;
            this.ctx.lineCap = 'round';

            if (this.currentTool === 'erase') {
                this.ctx.globalCompositeOperation = 'destination-out';
            } else {
                this.ctx.globalCompositeOperation = 'source-over';
                this.ctx.strokeStyle = this.currentColor;
            }

            this.ctx.lineTo(pos.x, pos.y);
            this.ctx.stroke();
            this.ctx.beginPath();
            this.ctx.moveTo(pos.x, pos.y);
        }

        stopDrawing() {
            this.isDrawing = false;
            this.ctx.beginPath();
        }

        addText(pos) {
            const text = prompt('Enter text:');
            if (text) {
                this.ctx.font = `${this.currentSize * 5}px Arial`;
                this.ctx.fillStyle = this.currentColor;
                this.ctx.fillText(text, pos.x, pos.y);
            }
        }

        clearCanvas() {
            if (confirm('Are you sure you want to clear the canvas?')) {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.drawBackground();
            }
        }

        startTimer() {
            setInterval(() => {
                const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('timer').textContent =
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        getCanvasData() {
            return this.canvas.toDataURL('image/png');
        }

        getTimeSpent() {
            return Math.floor((Date.now() - this.startTime) / 1000);
        }

        async submitDrawing() {
            const canvasData = this.getCanvasData();
            const timeSpent = this.getTimeSpent();

            // Show loading modal
            const modal = new bootstrap.Modal(document.getElementById('submissionModal'));
            modal.show();

            try {
                const response = await fetch(`/api/topic/{{ topic.id }}/submit/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        canvas_data: canvasData,
                        time_spent: timeSpent
                    })
                });

                const result = await response.json();

                if (result.success) {
                    this.displayResult(result);
                } else {
                    this.displayError(result.error);
                }
            } catch (error) {
                this.displayError('Network error. Please try again.');
            }
        }

        displayResult(result) {
            const resultDiv = document.getElementById('submissionResult');
            const continueBtn = document.getElementById('continueBtn');

            if (result.is_correct) {
                resultDiv.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-check-circle text-success fa-4x mb-3"></i>
                    <h4 class="text-success">Excellent Work!</h4>
                    <p>${result.message}</p>
                    <div class="alert alert-success">
                        <strong>Score: ${result.score}/20</strong>
                    </div>
                </div>
            `;

                continueBtn.style.display = 'inline-block';
                continueBtn.onclick = () => window.location.reload();
            } else {
                resultDiv.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-warning fa-4x mb-3"></i>
                    <h4 class="text-warning">Keep Trying!</h4>
                    <div class="alert alert-info">
                        <strong>Score: ${result.score}/20</strong>
                    </div>
                    <div class="alert alert-warning">
                        ${result.feedback}
                    </div>
                </div>
            `;

                continueBtn.style.display = 'inline-block';
                continueBtn.onclick = () => {
                    // Update background and instructions if provided
                    if (result.updated_background) {
                        const bgImg = document.getElementById('backgroundImage');
                        if (bgImg) {
                            bgImg.src = result.updated_background;
                        }
                    }

                    if (result.updated_instructions) {
                        document.getElementById('instructionalText').innerHTML =
                            result.updated_instructions.replace(/\n/g, '<br>');
                    }

                    // Close modal and allow new attempt
                    bootstrap.Modal.getInstance(document.getElementById('submissionModal')).hide();
                };
            }
        }

        displayError(error) {
            const resultDiv = document.getElementById('submissionResult');
            resultDiv.innerHTML = `
            <div class="text-center">
                <i class="fas fa-exclamation-circle text-danger fa-4x mb-3"></i>
                <h4 class="text-danger">Error</h4>
                <p>${error}</p>
            </div>
        `;
        }
    }

    // Initialize canvas when page loads
    document.addEventListener('DOMContentLoaded', function () {
        const canvas = new DrawingCanvas('drawingCanvas');

        // Add CSRF token to all AJAX requests
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            // Create CSRF token input if it doesn't exist
            const token = document.createElement('input');
            token.type = 'hidden';
            token.name = 'csrfmiddlewaretoken';
            token.value = '{{ csrf_token }}';
            document.body.appendChild(token);
        }
    });
</script>
{% endblock %}